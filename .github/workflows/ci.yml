name: CI
on:
  push: {}
  pull_request: {}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - run: pnpm install
      - run: pnpm build
      - run: pnpm test
      - run: pnpm lint
  create_tgz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: corepack enable
      - run: pnpm install
      - run: pnpm build
      - run: npm pack
      - name: rename tgz
        run: mv $(ls | grep .tgz) pkg.tgz
      - name: arethetypeswrong
        run: npx --yes @arethetypeswrong/cli ./pkg.tgz
      - name: write devDependencies to dist # we're only going to install some devDependencies, this helps ensure we get the right ones
        run: cat package.json | jq .devDependencies > dist/devDependencies.json
      - uses: actions/upload-artifact@v4
        with:
          name: tarball
          path: pkg.tgz
  test_tgz:
    runs-on: ubuntu-latest
    needs: [create_tgz]
    strategy:
      matrix:
        node: [23, 22]
        rpc_lib: 
          - '@trpc/server@^10.0.0'
          - '@trpc/server@^11.0.0'
          - '@orpc/server@^1.0.0'
        schema_lib:
          - 'zod@3.0.0'
          - 'zod@~3.24.4'
          - 'zod@~3.25.76'
          - 'zod@^4.0.0'
          - 'valibot@^1.0.0'
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      - uses: actions/download-artifact@v4
        with:
          name: tarball
      - run: ls
      - run: mkdir test-dir
      - name: setup test-dir
        working-directory: test-dir
        run: |
          npm init -y
          npm install ../pkg.tgz --save-dev --save-exact
          installDev() {
            npm install "$@@$(cat ./node_modules/trpc-cli/dist/devDependencies.json | jq -r ".$@")"
          }
          installDev typescript
          installDev tsx
          npm install ${{ matrix.rpc_lib }}
          npm install ${{ matrix.schema_lib }}
          echo '{
            "compilerOptions": {
                "target": "ES2022",
                "lib": ["ES2022"],
                "skipLibCheck": true,
                "strict": true,
                "declaration": true,
                "esModuleInterop": true,
                "module": "NodeNext",
                "moduleResolution": "NodeNext"
            },
            "include": ["*.ts"]
          }' > tsconfig.json

          if [[ "${{ matrix.rpc_lib }}" =~ "@trpc/server" ]]; then
          echo '
          import {createCli} from "trpc-cli"
          import * as trpcServer from "@trpc/server"
          import {InputSchema} from "./input-schema"

          const t = trpcServer.initTRPC.create()

          export const router = t.router({
            sayHello: t.procedure
              .input(InputSchema)
              .query(({input: [name, {enthusiasm}]}) => {
                return `Hello ${name}` + "!".repeat(enthusiasm)
              })
          })

          void createCli({router}).run()
          ' > trpc-cli-test.ts
          fi

          if [[ "${{ matrix.rpc_lib }}" =~ "@orpc/server" ]]; then
          echo '
          import {createCli} from "trpc-cli"
          import {os} from "@orpc/server"
          import {InputSchema} from "./input-schema"

          export const router = os.router({
            sayHello: os
              .input(InputSchema)
              .handler(({input: [name, {enthusiasm}]}) => {
                return `Hello ${name}` + "!".repeat(enthusiasm)
              })
          })

          void createCli({router}).run()
          ' > trpc-cli-test.ts
          fi

          if [[ "${{ matrix.schema_lib }}" =~ "zod" ]]; then
          echo '
          import {z} from "zod"

          export const InputSchema = z.tuple([
            z.string().describe("name"),
            z.object({
              enthusiasm: z.number().int().positive().describe("exclamation marks"),
            })
          ])
          ' > input-schema.ts
          fi

          if [[ "${{ matrix.schema_lib }}" =~ "valibot" ]]; then
          echo '
          v.tuple([
            v.pipe(v.string(), v.description("name")),
            v.object({
              enthusiasm: v.pipe(v.number(), v.integer(), v.description("exclamation marks")),
            }),
          ])
          ' > input-schema.ts
          fi

          # let's create an equivalent file without using `trpc-cli` imports at all - we'll test the bin script on this
          # to make sure it's possible to use the package's CLI on an existing trpc router.
          cat trpc-cli-test.ts | grep -v .run > normal-router-test.ts

          cat trpc-cli-test.ts
          cat normal-router-test.ts
      - name: bundle
        working-directory: test-dir
        # tsdown and other bundlers sometimes complain about requires of peerDependencies, let's make sure the output is clean
        run: |
          npm install tsdown --save-dev --save-exact
          npx tsdown trpc-cli-test.ts | tee tsdown-output.txt

          if grep -i "warning" tsdown-output.txt || grep -i "error" tsdown-output.txt; then
            echo "tsdown output had problems"
            exit 1
          fi
      - name: compile
        working-directory: test-dir
        run: npx tsc -p .

      - name: run test
        working-directory: test-dir
        run: |
          echo testing --help
          node trpc-cli-test.js --help

          echo checking --help output
          node trpc-cli-test.js --help | grep say-hello

          echo testing say-hello
          node trpc-cli-test.js say-hello mmkal --enthusiasm 3

          echo checking say-hello output
          node trpc-cli-test.js say-hello mmkal --enthusiasm 3 | grep 'Hello mmkal!'
      - name: test bin script
        working-directory: test-dir
        run: |
          echo testing --help
          ./node_modules/.bin/trpc-cli normal-router-test.ts --help

          echo checking --help output
          ./node_modules/.bin/trpc-cli normal-router-test.ts --help | grep say-hello

          echo testing say-hello
          ./node_modules/.bin/trpc-cli normal-router-test.ts say-hello mmkal --enthusiasm 3

          echo checking say-hello output
          ./node_modules/.bin/trpc-cli normal-router-test.ts say-hello mmkal --enthusiasm 3 | grep 'Hello mmkal!'
      - name: tsx test
        if: failure()
        working-directory: test-dir
        run: |
          npx tsx normal-router-test.ts --help
          npx tsx normal-router-test.ts say-hello mmkal --enthusiasm 3
      - run: ls -R && cat test-dir/normal-router-test.ts
        if: always()
  test_tgz_alt_deps:
    runs-on: ubuntu-latest
    needs: [create_tgz]
    strategy:
      matrix:
        node: [23, 22]
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      - uses: actions/download-artifact@v4
        with:
          name: tarball
      - run: ls
      - run: mkdir test-dir
      - name: setup test-dir
        working-directory: test-dir
        run: |
          npm init -y
          npm install ../pkg.tgz --save-dev --save-exact
          installDev() {
            npm install "$@@$(cat ./node_modules/trpc-cli/dist/devDependencies.json | jq -r ".$@")"
          }
          installDev typescript
          installDev tsx
          installDev @orpc/server
          installDev valibot
          installDev @valibot/to-json-schema
          echo '{
            "compilerOptions": {
                "target": "ES2022",
                "lib": ["ES2022"],
                "skipLibCheck": true,
                "strict": true,
                "declaration": true,
                "esModuleInterop": true,
                "module": "NodeNext",
                "moduleResolution": "NodeNext"
            },
            "include": ["*.ts"]
          }' > tsconfig.json
          echo '
          import {createCli} from "trpc-cli"
          import * as v from "valibot"
          import {os} from "@orpc/server"

          export const router = os.router({
            sayHello: os
              .input(
                v.tuple([
                  v.pipe(v.string(), v.description("name")),
                  v.object({
                    enthusiasm: v.pipe(v.number(), v.integer(), v.description("exclamation marks")),
                  }),
                ]),
              )
              .handler(({input: [name, {enthusiasm}]}) => {
                return `Hello ${name}` + "!".repeat(enthusiasm)
              })
          })

          void createCli({router}).run()
          ' > trpc-cli-test.ts


          # let's create an equivalent file without using `trpc-cli` imports at all - we'll test the bin script on this
          # to make sure it's possible to use the package's CLI on an existing trpc router.
          cat trpc-cli-test.ts | grep -v .run > normal-router-test.ts

          cat trpc-cli-test.ts
          cat normal-router-test.ts
      - name: bundle
        working-directory: test-dir
        # tsdown and other bundlers sometimes complain about requires of peerDependencies, let's make sure the output is clean
        run: |
          npm install tsdown --save-dev --save-exact
          npx tsdown trpc-cli-test.ts | tee tsdown-output.txt

          if grep -i "warning" tsdown-output.txt || grep -i "error" tsdown-output.txt; then
            echo "tsdown output had problems"
            exit 1
          fi
      - name: compile
        working-directory: test-dir
        run: npx tsc -p .

      - name: run test
        working-directory: test-dir
        run: |
          echo testing --help
          node trpc-cli-test.js --help

          echo checking --help output
          node trpc-cli-test.js --help | grep say-hello

          echo testing say-hello
          node trpc-cli-test.js say-hello mmkal --enthusiasm 3

          echo checking say-hello output
          node trpc-cli-test.js say-hello mmkal --enthusiasm 3 | grep 'Hello mmkal!'
      - name: test bin script
        working-directory: test-dir
        run: |
          echo testing --help
          ./node_modules/.bin/trpc-cli normal-router-test.ts --help

          echo checking --help output
          ./node_modules/.bin/trpc-cli normal-router-test.ts --help | grep say-hello

          echo testing say-hello
          ./node_modules/.bin/trpc-cli normal-router-test.ts say-hello mmkal --enthusiasm 3

          echo checking say-hello output
          ./node_modules/.bin/trpc-cli normal-router-test.ts say-hello mmkal --enthusiasm 3 | grep 'Hello mmkal!'
      - name: tsx test
        if: failure()
        working-directory: test-dir
        run: |
          npx tsx normal-router-test.ts --help
          npx tsx normal-router-test.ts say-hello mmkal --enthusiasm 3
      - run: ls -R && cat test-dir/normal-router-test.ts && cat test-dir/node_modules/trpc-cli/dist/index.d.ts
        if: always()
      - run: cat test-dir/node_modules/trpc-cli/dist/index.d.ts
        if: always()
